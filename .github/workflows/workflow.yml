name: workflow

on: [push, pull_request]

jobs:
    build:
        name: Build

        # https://github.com/mit-plv/fiat-crypto/pull/1971/files
        runs-on: ubuntu-22.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                submodules: recursive

            # Restore cache BEFORE setup-ocaml so it can detect the existing switch
            - name: Restore opam switch cache
              id: opam-cache
              uses: actions/cache@v5
              with:
                path: |
                  _opam
                  ~/.opam/download-cache
                key: opam-${{ runner.os }}-5.1.1-${{ hashFiles('**/*.opam') }}

            - name: Set-up OCaml
              uses: ocaml/setup-ocaml@v3
              with:
                ocaml-compiler: 5.1.1
                dune-cache: true
                opam-pin: false

            - name: Cache Python dependencies
              uses: actions/cache@v5
              with:
                path: ~/.cache/pip
                key: pip-${{ runner.os }}-${{ hashFiles('scripts/*.py') }}

            - name: Install dependencies
              run: opam install . --deps-only --with-test --yes

            - run: make config

            - run: make build

            - run: make test

            - name: Subck is kinda flaky
              run: make subck
              continue-on-error: true

    proof:
        name: Proof

        runs-on: ubuntu-22.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                submodules: recursive

            # Cache BEFORE setup-ocaml so it can detect existing switch
            - name: Restore Coq opam cache
              uses: actions/cache@v5
              with:
                path: |
                  _opam
                  ~/.opam/download-cache
                key: opam-coq-${{ runner.os }}-ocaml-5.1.1-coq-8.20.0

            - name: Set-up OCaml
              uses: ocaml/setup-ocaml@v3
              with:
                ocaml-compiler: 5.1.1
                opam-pin: false

            - name: Cache proof artifacts
              uses: actions/cache@v5
              with:
                path: underapproximation_type/data/validation/proofs
                key: proof-${{ runner.os }}-coq-8.20.0-${{ hashFiles('underapproximation_type/coq_proof/**/*.v', 'underapproximation_type/coq_proof/_CoqProject') }}

            - name: Install Coq
              run: opam install coq.8.20.0 -y

            - name: Regenerate Makefile
              run: cd underapproximation_type/data/validation/proofs && opam exec -- coq_makefile -f _CoqProject -o Makefile

            - name: Build proofs
              run: opam exec -- make proof
