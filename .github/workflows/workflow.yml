name: workflow

on: [push, pull_request]

jobs:
    build:
        name: Build

        # https://github.com/mit-plv/fiat-crypto/pull/1971/files
        runs-on: ubuntu-22.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                submodules: recursive

            - name: Set-up OCaml
              uses: ocaml/setup-ocaml@v3
              with:
                ocaml-compiler: 5.1.1
                dune-cache: true

            - name: Cache opam dependencies
              uses: actions/cache@v5
              with:
                path: ~/.opam
                key: opam-${{ runner.os }}-5.1.1-${{ hashFiles('**/*.opam') }}
                restore-keys: |
                  opam-${{ runner.os }}-5.1.1-
                  opam-${{ runner.os }}-

            - name: Cache dune build directory
              uses: actions/cache@v5
              with:
                path: _build
                key: dune-${{ runner.os }}-5.1.1-${{ hashFiles('**/dune', '**/dune-project', '**/*.ml', '**/*.mli') }}
                restore-keys: |
                  dune-${{ runner.os }}-5.1.1-
                  dune-${{ runner.os }}-

            - name: Cache Python dependencies
              uses: actions/cache@v5
              with:
                path: ~/.cache/pip
                key: pip-${{ runner.os }}-${{ hashFiles('scripts/*.py') }}
                restore-keys: |
                  pip-${{ runner.os }}-

            - run: opam install . --deps-only --with-test

            - run: make config

            - run: make build

            - run: make test

            - name: Subck is kinda flaky
              run: make subck
              continue-on-error: true

    proof:
        name: Proof

        runs-on: ubuntu-22.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                submodules: recursive

            - name: Set-up OCaml
              uses: ocaml/setup-ocaml@v3
              with:
                ocaml-compiler: 5.1.1

            - name: Cache proof artifacts
              uses: actions/cache@v5
              with:
                path: underapproximation_type/data/validation/proofs
                key: proof-${{ runner.os }}-coq-${{ hashFiles('underapproximation_type/data/validation/proofs/**') }}
                restore-keys: |
                  proof-${{ runner.os }}-coq-

            - name: Install Coq
              run: opam install coq -y

            - name: Regenerate Makefile
              run: cd underapproximation_type/data/validation/proofs && opam exec -- coq_makefile -f _CoqProject -o Makefile

            - name: Build proofs
              run: opam exec -- make proof